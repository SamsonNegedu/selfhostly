services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: selfhostly-backend-dev
    ports:
      - "8080:8080"
    environment:
      SERVER_ADDRESS: ":8080"
      DATABASE_PATH: /app/data/selfhostly.db
      APPS_DIR: /app/apps
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:-}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:-}
      AUTH_ENABLED: ${AUTH_ENABLED:-false}
      # Development settings
      GIN_MODE: debug
    volumes:
      # Mount source code for live reload (Air will watch these files)
      - .:/app
      # Mount data directories
      - ./data:/app/data
      - ./apps:/app/apps
      # Mount Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Exclude tmp directory from host
      - /app/tmp
    networks:
      - selfhostly-network
    restart: unless-stopped

  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    container_name: selfhostly-frontend-dev
    ports:
      - "3000:3000"
    environment:
      # Vite will proxy /api and /auth requests to the backend container
      VITE_API_BASE: http://backend:8080
    volumes:
      # Mount web source for live reload
      - ./web:/app
      # Prevent overwriting node_modules from host
      - /app/node_modules
    networks:
      - selfhostly-network
    depends_on:
      - backend
    restart: unless-stopped

networks:
  # Core API network - must match constants.CoreAPINetwork in internal/constants/constants.go
  selfhostly-network:
    name: selfhostly-network # Use exact name, no project prefix
    driver: bridge
